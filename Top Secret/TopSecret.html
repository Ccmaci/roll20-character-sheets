<input type="text" class="hidden" name="attr_sheet_version" value="0" title="@{sheet_version}" />
<div class='main'>
    <div class='logo-text'>
        <div class='logo-text-first-line'>
            TOP
        </div>
        <div class='logo-text-second-line'>
            SECRET
        </div>
    </div>
    <div class='page-title'>AGENT'S DOSSIER</div>
    <div class="two-column-grid">
        <div class="span-2">
            <label>CHARACTER NAME <input type="text" class="name-field" name="attr_character_name" value="" title="@{character_name}"></label>
            <!-- deprecated attribute -->
            <input type="text" class="hidden" name="attr_CharacterName">
        </div>
        <div class="span-2">
            <span class="general-column-header nowrap">Alias <input type="text" name="attr_Alias" title="@{Alias}"></span>
            <span class="general-column-header nowrap">Code Name <input type="text" name="attr_CodeName" title="@{CodeName}"></span>
        </div>
    </div>
    <input type="radio" name="attr_tab" class="tab tab1" value="1" title="Traits" checked="checked" /><span></span>
    <input type="radio" name="attr_tab" class="tab tab2" value="2" title="Stats" /><span></span>
    <input type="radio" name="attr_tab" class="tab tab3" value="3" title="Equipment" /><span></span>
    <input type="radio" name="attr_tab" class="tab tab4" value="4" title="Knowledge" /><span></span>
    <input type="radio" name="attr_tab" class="tab tab5" value="5" title="People" /><span></span>
    <input type="radio" name="attr_tab" class="tab tab6" value="6" title="Misc" /><span></span>

    <div class='tab-content tab1'>
        <div class='three-column-fit'>
            <div class='traits-column'>
                <div class='section-title'>PRIMARY PERSONAL TRAITS</div>
                <div class='instruction'>(If die roll is 01-25, add 25; 26-50, add 15; 51-70, add 10; 71-90, add 5)</div>
                <div class='two-column-grid'>
                    <label>Physical Strength</label>
                    <input type='text' name='attr_PhysicalStrength' title="@{PhysicalStrength}" class='trait-box'/>

                    <label>Charm</label>
                    <input type='text' name='attr_Charm' title="@{Charm}" class='trait-box'/>

                    <label>Willpower</label>
                    <input type='text' name='attr_Willpower' title="@{Willpower}" class='trait-box'/>

                    <label>Courage</label>
                    <input type='text' name='attr_Courage' title="@{Courage}" class='trait-box'/>

                    <label>Knowledge</label>
                    <input type='text' name='attr_Knowledge' title="@{Knowledge}" class='trait-box'/>

                    <label>Coordination</label>
                    <input type='text' name='attr_Coordination' title="@{Coordination}" class='trait-box'/>
                </div>
            </div>
            <div class='traits-column'>
                <div class='section-title'>SECONDARY PERSONAL TRAITS</div>
                <div class='two-column-grid'>
                    <label>Offense</label>
                    <input type='text' name='attr_Offense' class='trait-box' title="@{Offense} | round((@{Coordination} + @{Courage})/2)" value="0" readonly/>

                    <label>Deception</label>
                    <input type='text' name='attr_Deception' class='trait-box' title="@{Deception} | round((@{Charm} + @{Courage})/2)" value="0" readonly/>

                    <label>Evasion</label>
                    <input type='text' name='attr_Evasion' class='trait-box' title="@{Evasion} | round((@{Coordination} + @{Charm})/2)" value="0" readonly/>

                    <label>Deactivation</label>
                    <input type='text' name='attr_Deactivation' class='trait-box' title="@{Deactivation} | round((@{Coordination} + @{Knowledge})/2)" value="0" readonly/>

                    <label>Movement Value</label>
                    <input type='text' name='attr_MovementValue' class='trait-box' title="@{MovementValue} | @{Coordination} + @{PhysicalStrength} + @{Willpower}" value="0" readonly/>

                    <label>Life Level</label>
                    <span>
                        <input type='text' name='attr_LifeLevel' class='trait-box' title="@{LifeLevel}" value="0" />
                        <span class="division">/</span>
                        <input type='text' name='attr_LifeLevel_max' class='trait-box' title="@{LifeLevel_max} | round((@{PhysicalStrength} + @{Willpower})/10)" value="0" readonly/>
                    </span>
                    <!-- deprecated attribute -->
                    <input type='text' name='attr_CurrentLifeLevel' class='hidden' value="0" />
                </div>
            </div>
            <div class='traits-column'>
                <div class='section-title'>TERTIARY PERSONAL TRAITS</div>
                <div class='two-column-grid'>
                    <label>Hand-to-hand Combat Value</label>
                    <input type='text' name='attr_HandToHandCombatValue' class='trait-box' title="@{HandToHandCombatValue} | @{PhysicalStrength} + @{Evasion}" value="0" readonly/>

                    <label>Wrestling Value</label>
                    <input type='text' name='attr_WrestlingValue' class='trait-box' title="@{WrestlingValue} | @{PhysicalStrength} + @{Offense}" value="0" readonly/>

                    <label>Surprise Value</label>
                    <input type='text' name='attr_SurpriseValue' class='trait-box' title="@{SurpriseValue} | @{Deception} + @{Evasion}" value="0" readonly/>
                </div>
            </div>
        </div>
    </div>

    <div class='tab-content tab2'>
        <div>
            <div class='section-title'>VITAL STATISTICS</div>
            <div class="flex-row">
                <label>
                    <span class="right-aligned">Height</span>
                    <input type="text" class="height-column" name="attr_Height" title="@{Height}">
                </label>
                <label>
                    <span class="right-aligned">Weight</span>
                    <input type="text" class="weight-column" name="attr_Weight" title="@{Weight}">
                </label>
                <label>
                    <span class="right-aligned">Age</span>
                    <input type="text" class="age-column" name="attr_Age" title="@{Age}">
                </label>
                <label>
                    <span class="right-aligned">Sex</span>
                    <input type="text" class="sex-column" name="attr_Sex" title="@{Sex}">
                </label>
                <label>
                    <span class="right-aligned">National Origin</span>
                    <input type="text" name="attr_NationalOrigin" title="@{NationalOrigin}">
                </label>
            </div>
            <div class='flex-row'>
                <label>
                    <span class='right-aligned'>Handedness</span>
                    <input type='text' class='handedness-field' name='attr_Handedness' title="@{Handedness}"/>
                </label>
                <label>
                    <span class='right-aligned'>Race</span>
                    <input type='text' name='attr_Race' title="@{Race}"/>
                </label>
                <label>
                    <span class='right-aligned'>Glasses</span>
                    <input type='checkbox' name='attr_Glasses' title="@{Glasses}"/>
                </label>
                <label>
                    <span class='right-aligned'>Contacts</span>
                    <input type='checkbox' name='attr_Contacts' title="@{Contacts}"/>
                </label>
            </div>
            <div class='two-column-grid'>
                <label>Languages Known</label>
                <label>Fluency</label>
                <label class="nowrap">
                    <input type='text' class='languages-known-field' name='attr_NativeLanguage' title="@{NativeLanguage}">(Native)</input>
                </label>
                <input type='text' class='language-fluency-field' name='attr_NativeLanguageFluency' title="@{NativeLanguageFluency}"/>
            </div>
            <fieldset class="repeating_Languages">
                <div class='two-column-grid'>
                        <input type='text' class='languages-known-field' name='attr_Language' title="@{Language}"/>
                        <input type='text' class='language-fluency-field' name='attr_LanguageFluency' title="@{LanguageFluency}"/>
                </div>
            </fieldset>
        </div>
        <div>
            <div class='section-title'>CLASSIFIED INFORMATION</div>
            <label>Bureau <input type='text' name='attr_Bureau' title="@{Bureau}"/></label>
            <label>Total Experience Points <input type='text' name='attr_TotalExp' title="@{TotalExp}"/></label>
            <label>Level <input type='text' name='attr_Level' title="@{Level}"/></label>
            <label>Fame Points <input type='text' name='attr_FamePoints' title="@{FamePoints}"/></label>
            <label>Fortune Points <input type='text' name='attr_FortunePoints' title="@{FortunePoints}"/></label>
            <label>Experience Points Used <input type='text' name='attr_ExpUsed' title="@{ExpUsed}"/></label>
            <label>Unused Experience Points <input type='text' name='attr_UnusedExp' title="@{UnusedExp}"/></label>
        </div>
    </div>

    <div class='tab-content tab3'>
        <div>
            <div class='section-title'>WEAPONS</div>

            <div class="hit-determination-grid">
                <div class="span-all"><label>HIT DETERMINATION</label></div>

                <span class="general-column-header">Range of Target</span>
                <span class="general-column-header">Movement of Shooter</span>
                <span class="general-column-header">Movement of Target</span>

                <span style="display: inline-flex">
                    <label><span>PB</span><input type="radio" name="attr_range_of_target" value="0" /></label>
                    <label><span>S</span><input type="radio" name="attr_range_of_target" value="1" /></label>
                    <label><span>M</span><input type="radio" name="attr_range_of_target" value="2" /></label>
                    <label><span>L</span><input type="radio" name="attr_range_of_target" value="3" /></label>
                </span>
                <select name="attr_move_of_shooter"></select>
                <select name="attr_move_of_target"></select>

                <span class="general-column-header">Wounds</span>
                <span class="general-column-header">Miscellaneous</span>
                <span class="general-column-header">Automatic</span>

                <select name="attr_wounds"></select>
                <select name="attr_miscellaneous"></select>
                <select name="attr_automatic"></select>
            </div>
            <div class='weapons-grid'>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span class='weapon-range-modifier-column'>Range Modifier</span>
                <span></span>

                <span></span>
                <span class='weapon-column'>WEAPON</span>
                <span class='weapon-speed-column'>Weapon Speed</span>
                <span class='weapon-base-speed-column'>BASE SPEED</span>
                <span class='weapon-pwv-column'>PWV</span>
                <span class='weapon-base-accuracy-column'>BASE ACCURACY</span>
                <span class='weapon-range-modifier-subcolumn'>PB</span>
                <span class='weapon-range-modifier-subcolumn'>S</span>
                <span class='weapon-range-modifier-subcolumn'>M</span>
                <span class='weapon-range-modifier-subcolumn'>L</span>
                <span class='weapon-rate-column'>Rate</span>
            </div>
            <fieldset class="repeating_Weapons">
                <div class='weapons-grid'>
                    <button type="roll" name="roll_attack" title="%{repeating_Weapons_$X_attack}" value="&{template:default} {{name=@{character_name} - Attack}} {{PB Range=[[ 1d100cs<[[ [[@{BaseAccuracy} [base] ]] + ([[ @{RangeModifierPB} [range] ]]) + ([[ ?{Additional Modifier|0} ]]) ]] ]] vs [[ [[@{BaseAccuracy} [base] ]] + ([[ @{RangeModifierPB} [range] ]]) + ([[ ?{Additional Modifier|0} ]]) ]]}} {{S Range=[[ 1d100cs<[[ [[@{BaseAccuracy} [base] ]] + ([[ @{RangeModifierS} [range] ]]) + ([[ ?{Additional Modifier|0} ]]) ]] ]] vs [[ [[@{BaseAccuracy} [base] ]] + ([[ @{RangeModifierS} [range] ]]) + ([[ ?{Additional Modifier|0} ]]) ]]}} {{M Range=[[ 1d100cs<[[ [[@{BaseAccuracy} [base] ]] + ([[ @{RangeModifierM} [range] ]]) + ([[ ?{Additional Modifier|0} ]]) ]] ]] vs [[ [[@{BaseAccuracy} [base] ]] + ([[ @{RangeModifierM} [range] ]]) + ([[ ?{Additional Modifier|0} ]]) ]]}} {{L Range=[[ 1d100cs<[[ [[@{BaseAccuracy} [base] ]] + ([[ @{RangeModifierL} [range] ]]) + ([[ ?{Additional Modifier|0} ]]) ]] ]] vs [[ [[@{BaseAccuracy} [base] ]] + ([[ @{RangeModifierL} [range] ]]) + ([[ ?{Additional Modifier|0} ]]) ]]}}"></button>
                    <input type='text' class='weapon-column' name='attr_Weapon' title="@{repeating_Weapons_$X_Weapon}"/>
                    <select name='attr_WeaponSpeedModifier' title="@{repeating_Weapons_$X_WeaponSpeedModifier}" class='weapon-speed-column'>
                        <option value="-10">Very Slow</option>
                        <option value="-5">Slow</option>
                        <option value="-3">Below Average</option>
                        <option value="0">Average</option>
                        <option value="5">Fast</option>
                        <option value="10">Very Fast</option>
                    </select>
                    <input type='text' class='weapon-base-speed-column' name='attr_BaseSpeed' title="@{repeating_Weapons_$X_BaseSpeed | @{WeaponSpeedModifier} + @{Offense}}" value='0' readonly/>
                    <input type='text' class='weapon-pwv-column' name='attr_PWV' title="@{repeating_Weapons_$X_PWV}"/>
                    <input type='text' class='weapon-base-accuracy-column' name='attr_BaseAccuracy' title="@{repeating_Weapons_$X_BaseAccuracy | @{PWV} + @{Offense}" value='0' readonly/>
                    <input type='text' class='weapon-range-modifier-subcolumn' name='attr_RangeModifierPB' title="@{repeating_Weapons_$X_RangeModifierPB}" value='0'/>
                    <input type='text' class='weapon-range-modifier-subcolumn' name='attr_RangeModifierS' title="@{repeating_Weapons_$X_RangeModifierS}" value='0'/>
                    <input type='text' class='weapon-range-modifier-subcolumn' name='attr_RangeModifierM' title="@{repeating_Weapons_$X_RangeModifierM}" value='0'/>
                    <input type='text' class='weapon-range-modifier-subcolumn' name='attr_RangeModifierL' title="@{repeating_Weapons_$X_RangeModifierL}" value='0'/>
                    <!--<input type='text' class='weapon-range-modifier-column' name='attr_RangeModifier' title="@{repeating_Weapons_$X_RangeModifier}"-->
                    <input type='text' class='weapon-rate-column' name='attr_Rate' title="@{repeating_Weapons_$X_Rate}" value='0'/>
                </div>
            </fieldset>
        </div>
        <div class="three-column-fit">
            <div>
                <div class='section-title'>EQUIPMENT CARRIED</div>
                <div class='two-column-grid'>
                    <div class='general-column-header'>
                        <span>ITEM</span>
                    </div>
                    <div class='general-column-header'>
                        <span>LOCATION</span>
                    </div>
                </div>
                <fieldset class="repeating_EquipmentCarried">
                    <div class='two-column-grid'>
                        <div>
                            <input type='text' class='full-width-element' name='attr_Item' title="@{repeating_EquipmentCarried_$X_Item}"/>
                        </div>
                        <div>
                            <input type='text' class='full-width-element' name='attr_Location' title="@{repeating_EquipmentCarried_$X_Location}"/>
                        </div>
                    </div>
                </fieldset>
            </div>
            <div>
                <div class='section-title'>OTHER ITEMS CARRIED</div>
                <div class='two-column-grid'>
                    <div class='general-column-header'>
                        <span>ITEM</span>
                    </div>
                    <div class='general-column-header'>
                        <span>LOCATION</span>
                    </div>
                </div>
                <fieldset class="repeating_OtherItemsCarried">
                    <div class='two-column-grid'>
                        <div>
                            <input type='text' class='full-width-element' name='attr_Item' title="@{repeating_OtherItemsCarried_$X_Item}"/>
                        </div>
                        <div>
                            <input type='text' class='full-width-element' name='attr_Location' title="@{repeating_OtherItemsCarried_$X_Location}"/>
                        </div>
                    </div>
                </fieldset>
            </div>
            <div>
                <div class='section-title'>MONEY & VALUABLES</div>
                <div class='two-column-grid'>
                    <div class='general-column-header'>
                        <span>AMOUNT OR ITEM</span>
                    </div>
                    <div class='general-column-header'>
                        <span>LOCATION</span>
                    </div>
                </div>
                <fieldset class="repeating_MoneyAndValuables">
                    <div class='two-column-grid'>
                        <div>
                            <input type='text' class='full-width-element' name='attr_Item' title="@{repeating_MoneyAndValuables_$X_Item}"/>
                        </div>
                        <div>
                            <input type='text' class='full-width-element' name='attr_Location' title="@{repeating_MoneyAndValuables_$X_Location}"/>
                        </div>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>

    <div class='tab-content tab6'>
        <div class="three-column-fit">
            <div>
                <div class='section-title'>RESIDENCE</div>
                <textarea class='text-area residence-text-area' name='attr_Residence' title="@{Residence}"></textarea>
            </div>
            <div>
                <div class='section-title'>COVER</div>
                <textarea class='text-area cover-text-area' name='attr_Cover' title="@{Cover}"></textarea>
            </div>
            <div>
                <div class='section-title'>BRIEF PERSONAL HISTORY</div>
                <textarea class='text-area history-text-area' name='attr_BriefPersonalHistory' title="@{BriefPersonalHistory}"></textarea>
            </div>
            <div class='notes-col'>
                <div class='section-title'>NOTES</div>
                <textarea class='text-area notes-text-area' name='attr_Notes' title="@{Notes}"></textarea>
            </div>
        </div>
    </div>

    <div class='tab-content tab5'>
        <div class="three-column-fit">
            <div>
                <div class='section-title'>FRIENDS</div>
                <fieldset class="repeating_Friends">
                    <div>
                        <input type='text' class='full-width-element' name='attr_Name' title="@{repeating_Friends_$X_Name}"/>
                    </div>
                </fieldset>
            </div>
            <div>
                <div class='section-title'>CONTACTS</div>
                <fieldset class="repeating_Contacts">
                    <div>
                        <input type='text' class='full-width-element' name='attr_Name' title="@{repeating_Contacts_$X_Name}"/>
                    </div>
                </fieldset>
            </div>
            <div>
                <div class='section-title'>ENEMIES</div>
                <fieldset class="repeating_Enemies">
                    <div>
                        <input type='text' class='full-width-element' name='attr_Name' title="@{repeating_Enemies_$X_Name}"/>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>

    <div class='tab-content tab4'>
        <div class='section-title'>AREAS OF KNOWLEDGE</div>
        <div class='aok-grid'>
            <span class="span-2">
                <span>
                    <span class="general-column-header">#of AOK</span>
                    <input type='text' class='trait-box' name='attr_AreaOfKnowledgeKnown' title="@{AreaOfKnowledgeKnown} | round(@{Knowledge}/10)" value='0' readonly/>
                </span>
                <span>
                    <span class="general-column-header">Default</span>
                    <input type='text' class='trait-box' name='attr_AreaOfKnowledgeDefaultValue' title="@{AreaOfKnowledgeDefaultValue} | round(@{Knowledge}/2)" value='0' readonly/>
                </span>
            </span>
            <span class="general-column-header aok-col-1-heading">AOK</span>
            <span class="general-column-header">VALUE</span>
        </div>
        <fieldset class="repeating_AreasOfKnowledge">
            <div class='aok-grid'>
                <div class='aok-col-1'>
                    <select name='attr_AreasOfKnowledgeName' title="@{repeating_AreasOfKnowledge_$X_AreasOfKnowledgeName}">
                        <option>Agriculture</option>
                        <option>Animal Science</option>
                        <option>Architecture</option>
                        <option>Arts & Crafts</option>
                        <option>Astronomy/Space Science</option>
                        <option>Biology/Biochemistry</option>
                        <option>Botany</option>
                        <option>Chemistry</option>
                        <option>Computer Science</option>
                        <option>Ecology/Earth Sciences</option>
                        <option>Economics/Finance</option>
                        <option>Education/Indoctrination</option>
                        <option>Engineering, Aeronautical</option>
                        <option>Engineering, Construction/Civil</option>
                        <option>Engineering, Electrical</option>
                        <option>Engineering, Hydraulic</option>
                        <option>Engineering, Industrial</option>
                        <option>Engineering, Mechanical</option>
                        <option>Engineering, Transportation</option>
                        <option>Fine Arts</option>
                        <option>Geography</option>
                        <option>Geology</option>
                        <option>Home Economics</option>
                        <option>Law</option>
                        <option>Literature</option>
                        <option>Mathematics/Accounting</option>
                        <option>Medicine/Physiology</option>
                        <option>Metallurgy</option>
                        <option>Military Science/Weaponry</option>
                        <option>Photography</option>
                        <option>Physical Education</option>
                        <option>Physics</option>
                        <option>Political Science/Ideology</option>
                        <option>Psychology</option>
                        <option>Religion</option>
                        <option>Social Sciences</option>
                        <option>World History/Current Affairs</option>
                    </select>
                    <!-- deprecated attribute -->
                    <select class="hidden" name='attr_WeaponSpeedModifier' title="@{repeating_AreasOfKnowledge_$X_WeaponSpeedModifier}">
                        <option>Agriculture</option>
                        <option>Animal Science</option>
                        <option>Architecture</option>
                        <option>Arts & Crafts</option>
                        <option>Astronomy/Space Science</option>
                        <option>Biology/Biochemistry</option>
                        <option>Botany</option>
                        <option>Chemistry</option>
                        <option>Computer Science</option>
                        <option>Ecology/Earth Sciences</option>
                        <option>Economics/Finance</option>
                        <option>Education/Indoctrination</option>
                        <option>Engineering, Aeronautical</option>
                        <option>Engineering, Construction/Civil</option>
                        <option>Engineering, Electrical</option>
                        <option>Engineering, Hydraulic</option>
                        <option>Engineering, Industrial</option>
                        <option>Engineering, Mechanical</option>
                        <option>Engineering, Transportation</option>
                        <option>Fine Arts</option>
                        <option>Geography</option>
                        <option>Geology</option>
                        <option>Home Economics</option>
                        <option>Law</option>
                        <option>Literature</option>
                        <option>Mathematics/Accounting</option>
                        <option>Medicine/Physiology</option>
                        <option>Metallurgy</option>
                        <option>Military Science/Weaponry</option>
                        <option>Photography</option>
                        <option>Physical Education</option>
                        <option>Physics</option>
                        <option>Political Science/Ideology</option>
                        <option>Psychology</option>
                        <option>Religion</option>
                        <option>Social Sciences</option>
                        <option>World History/Current Affairs</option>
                    </select>
                </div>
                <div class='area-of-knowledge-value-column'>
                    <input type='text' class='trait-box' name='attr_AreaOfKnowledgeValue' title="@{repeating_AreasOfKnowledge_$X_AreaOfKnowledgeValue}"/>
                </div>
            </div>
        </fieldset>
    </div>
</div>

<rolltemplate class="sheet-rolltemplate-general"></rolltemplate>

<script type="text/worker">// move html calcs to sheetworkers
  // GLOBAL concatenates repeating attribute names
  // (repeating section, rowID, attribute)
  const section_attribute = (section, id, field) => `repeating_${section}_${id}_${field}`;
  // add version check to fix/migrate a couple attribute names
  // characterName s/b character_name
  // repeating_AreasOfKnowledge_$X_WeaponSpeedModifier s/b AreaOfKnowledgeName

  // trait calcs
  on('change:physicalstrength change:charm change:willpower change:courage change:knowledge change:coordination', (eventInfo) => {
    console.log(`Change detected: ${eventInfo.sourceAttribute}`);
    getAttrs(['physicalstrength', 'charm', 'willpower', 'courage', 'knowledge', 'coordination'], (v) => {
      const output = {};
      const physicalstrength = +v.physicalstrength || 0;
      const charm = +v.charm || 0;
      const willpower = +v.willpower || 0;
      const courage = +v.courage || 0;
      const knowledge = +v.knowledge || 0;
      const coordination = +v.coordination || 0;
      // secondary calcs
      const offense = Math.round((courage + coordination) / 2);
      console.log(`Change detected: offense:${offense}`);
      output.offense = offense;
      const deception = Math.round((charm + courage) / 2);
      console.log(`Change detected: deception:${deception}`);
      output.deception = deception;
      const evasion = Math.round((coordination + charm) / 2);
      console.log(`Change detected: evasion:${evasion}`);
      output.evasion = evasion;
      const deactivation = Math.round((coordination + knowledge) / 2);
      console.log(`Change detected: deactivation:${deactivation}`);
      output.deactivation = deactivation;
      const movementvalue = coordination + physicalstrength + willpower;
      console.log(`Change detected: movementvalue:${movementvalue}`);
      output.movementvalue = movementvalue;
      const lifelevelMax = Math.round((physicalstrength + willpower) / 10);
      console.log(`Change detected: lifelevel_max:${lifelevelMax}`);
      output.lifelevel_max = lifelevelMax;
      // tertiary calcs
      const handtohandcombatvalue = physicalstrength + evasion;
      console.log(`Change detected: handtohandcombatvalue:${handtohandcombatvalue}`);
      output.handtohandcombatvalue = handtohandcombatvalue;
      const wrestlingvalue = physicalstrength + offense;
      console.log(`Change detected: wrestlingvalue:${wrestlingvalue}`);
      output.wrestlingvalue = wrestlingvalue;
      const surprisevalue = deception + evasion;
      console.log(`Change detected: surprisevalue:${surprisevalue}`);
      output.surprisevalue = surprisevalue;
      // AOK
      const AOKdefault = Math.round(knowledge / 2);
      console.log(`Change detected: AOKdefault:${AOKdefault}`);
      output.AreaOfKnowledgeDefaultValue = AOKdefault;
      const AOKknown = Math.round(knowledge / 10);
      console.log(`Change detected: AOKknown:${AOKknown}`);
      output.AreaOfKnowledgeKnown = AOKknown;
      setAttrs(output);
    });
  });

  // weapon calcs
  on('change:repeating_weapons:weaponspeedmodifier change:repeating_weapons:pwv', (eventInfo) => {
    console.log(`Change detected: ${eventInfo.sourceAttribute}`);
    const id = eventInfo.sourceAttribute.split('_')[2];
    getAttrs(['offense', `repeating_weapons_${id}_weaponspeedmodifier`, `repeating_weapons_${id}_pwv`], (v) => {
      const output = {};
      const offense = +v.offense || 0;
      const weaponSpeed = +v[`repeating_weapons_${id}_weaponspeedmodifier`] || 0;
      const PWV = +v[`repeating_weapons_${id}_pwv`] || 0;
      output[`repeating_weapons_${id}_basespeed`] = offense + weaponSpeed;
      output[`repeating_weapons_${id}_baseaccuracy`] = offense + PWV;
      setAttrs(output, {silent: true});
    });
  });

  on('change:offense', (eventInfo) => {
    console.log(`Change detected: ${eventInfo.sourceAttribute}`);
    getSectionIDs('repeating_weapons', (idArray) => {
      const output = {};
      const fields = ['offense'];
      _.each(idArray, (id) => {
        fields.push(section_attribute('weapons', id, 'weaponspeedmodifier'));
        fields.push(section_attribute('weapons', id, 'pwv'));
      });
      getAttrs(fields, (v) => {
        idArray.forEach((id) => {
          const offense = +v.offense || 0;
          const weaponSpeed = +v[section_attribute('weapons', id, 'weaponspeedmodifier')];
          const PWV = +v[section_attribute('weapons', id, 'pwv')];
          output[section_attribute('weapons', id, 'basespeed')] = offense + weaponSpeed;
          output[section_attribute('weapons', id, 'baseaccuracy')] = offense + PWV;
        });
        setAttrs(output, {silent: true});
      });
    });
  });

  // one-time update
  on('sheet:opened', (eventInfo) => {
    console.log(`Change detected: sheet_version check`);
    getSectionIDs('repeating_AreasOfKnowledge', (idArray) => {
      const output = {};
      const fields = ['sheet_version', 'charactername', 'lifelevel', 'currentlifelevel'];
      _.each(idArray, (id) => {
        fields.push(section_attribute('AreasOfKnowledge', id, 'WeaponSpeedModifier'));
      });
      getAttrs(fields, (v) => {
        const sheetVersion = +v.sheet_version || 0;
        const characterName = v.charactername || 0;
        const oldLifeLevel = +v.lifelevel || 0;
        const oldCurrentLifeLevel = +v.currentlifelevel || 0;

        if (sheetVersion > 0) {
          console.log(`Change detected: sheet_version = ${sheetVersion}`);
          return;
        }
        if (characterName !== '') {
          console.log(`Change detected: character_name updated to ${characterName}`);
          output.character_name = characterName;
        }
        if (oldLifeLevel !== 0) {
          console.log(`Change detected: lifelevel has been changed to lifelevel_max`);
          output.lifelevel_max = oldLifeLevel;
        }
        if (oldCurrentLifeLevel !== 0) {
          console.log(`Change detected: currentlifelevel has been changed to lifelevel`);
          output.lifelevel = oldCurrentLifeLevel;
        }
        idArray.forEach((id) => {
          const currentValue = v[section_attribute('AreasOfKnowledge', id, 'WeaponSpeedModifier')];
          console.log(`Change detected: AreasOfKnowledgeName updated to ${currentValue}`);
          output[section_attribute('AreasOfKnowledge', id, 'AreasOfKnowledgeName')] = currentValue;
        });
        output.sheet_version = 1;
        console.log(`Change detected: Sheet update complete`);
        setAttrs(output, {silent: true});
      });
    });
  });
</script>