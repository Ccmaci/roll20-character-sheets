<div class="sheet-body">
	<div class="border">
		<h1 class="title">
			<img
				src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/Draw%20Steel/images/powered_by_draw_steel.webp"
				alt="Powered By Draw Steel"
				style="height: 60px"
			/>
		</h1>
		<div class="header-panel">
			<div class="profile-panel border">
				<div class="name-input-group">
					<input type="text" name="attr_character_name" />
					<label class="sublabel" data-i18n="character-name"></label>
				</div>
				<div class="ancestry-input-group">
					<input type="text" class="input-md" name="attr_ancestry" />
					<label class="sublabel" data-i18n="ancestry"></label>
				</div>
				<div class="class-input-group">
					<input type="text" class="input-md" name="attr_class" />
					<label class="sublabel" data-i18n="class"></label>
				</div>
				<div class="career-input-group">
					<input type="text" class="input-md" name="attr_career" />
					<label class="sublabel" data-i18n="career"></label>
				</div>
				<div class="subclass-input-group">
					<input type="text" class="input-md" name="attr_subclass" />
					<label class="sublabel" data-i18n="subclass"></label>
				</div>
			</div>
			<div class="progress-panel border">
				<div class="victories-input-group">
					<h5 data-i18n="victories"></h5>
					<input type="number" name="attr_victories" />
				</div>
				<div class="level-input-group">
					<h5 data-i18n="level"></h5>
					<input type="number" name="attr_level" />
				</div>
				<div class="wealth-input-group">
					<label data-i18n="wealth"></label>
					<input type="number" class="input-md" name="attr_wealth" />
				</div>
				<div class="renown-input-group">
					<label data-i18n="renown"></label>
					<input type="number" class="input-md" name="attr_renown" />
				</div>
				<div class="experience-input-group">
					<label data-i18n="experience"></label>
					<input type="number" class="input-md" name="attr_experience" />
				</div>
			</div>
		</div>
	</div>
	<div class="v-spacer"></div>
	<div class="stats-panel border minimizable">
		<div class="minimize-control">
			<input id="stats-minimize-checkbox" class="minimize" type="checkbox" checked />
			<label for="stats-minimize-checkbox" data-i18n="minimize-label"></label>
		</div>
		<div class="core-panel minimize-ignore border-right">
			<div class="characteristics minimize-ignore">
				<span>Click Characteristic to Power Roll</span>
				<div class="characteristic-input-group hexagon">
					<label data-characteristic="might" data-i18n="might"></label>
					<input type="number" name="attr_might" />
				</div>
				<div class="characteristic-input-group hexagon">
					<label data-characteristic="agility" data-i18n="agility"></label>
					<input type="number" name="attr_agility" />
				</div>
				<div class="characteristic-input-group hexagon">
					<label data-characteristic="reason" data-i18n="reason"></label>
					<input type="number" name="attr_reason" />
				</div>
				<div class="characteristic-input-group hexagon">
					<label data-characteristic="intuition" data-i18n="intuition"></label>
					<input type="number" name="attr_intuition" />
				</div>
				<div class="characteristic-input-group hexagon">
					<label data-characteristic="presence" data-i18n="presence"></label>
					<input type="number" name="attr_presence" />
				</div>
			</div>
			<div class="potencies">
				<h5 class="panel-title" data-i18n="potencies"></h5>
				<div>
					<label data-i18n="potency-strong"></label>
					<input type="number" class="input-md" name="attr_potency_strong" />
					<label data-i18n="potency-average"></label>
					<input type="number" class="input-md" name="attr_potency_average" />
					<label data-i18n="potency-weak"></label>
					<input type="number" class="input-md" name="attr_potency_weak" />
				</div>
			</div>
			<div class="movement">
				<div class="movement-input-group">
					<input type="text" class="input-md" name="attr_size" />
					<label class="sublabel" data-i18n="size"></label>
				</div>
				<div class="movement-input-group">
					<input type="number" class="input-md" name="attr_speed" />
					<label class="sublabel" data-i18n="speed"></label>
				</div>
				<div class="movement-input-group">
					<input type="number" class="input-md" name="attr_disengage" />
					<label class="sublabel" data-i18n="disengage"></label>
				</div>
				<div class="movement-input-group">
					<input type="number" class="input-md" name="attr_stability" />
					<label class="sublabel" data-i18n="stability"></label>
				</div>
			</div>
		</div>
		<div class="stamina-panel">
			<h5 class="panel-title" data-i18n="stamina"></h5>
			<div class="stamina-input-group">
				<input type="number" name="attr_stamina" />
				<label class="sublabel" data-i18n="stamina-current"></label>
			</div>
			<input type="number" class="input-md" name="attr_stamina_max" />
			<label class="sublabel" data-i18n="stamina-max"></label>
			<input type="number" class="input-md" name="attr_stamina_winded" />
			<label class="sublabel" data-i18n="winded"></label>
			<div class="stamina-temporary-input-group">
				<input type="number" class="input-md" name="attr_stamina_temporary" />
				<label class="sublabel" data-i18n="stamina-temporary"></label>
			</div>
			<input type="number" class="input-md" disabled value="0" />
			<label class="sublabel" data-i18n="dying"></label>
			<input type="number" class="input-md" name="attr_stamina_dead" />
			<label class="sublabel" data-i18n="dead"></label>
		</div>
		<div class="recoveries-panel">
			<h5 class="panel-title" data-i18n="recoveries"></h5>
			<div class="recoveries-input-group">
				<input type="number" name="attr_recoveries" />
			</div>
			<div class="recovery-amount-input-group">
				<input type="number" class="input-md" name="attr_recovery_amount" />
				<label class="sublabel" data-i18n="recovery-amount"></label>
			</div>
			<div class="recoveries-max-input-group">
				<input type="number" class="input-md" name="attr_recoveries_max" />
				<label class="sublabel" data-i18n="recoveries-max"></label>
			</div>
		</div>
		<div class="damage-mod-panel">
			<label>Immunity</label>
			<input type="text" class="input-md" name="attr_immunity" />
			<label>Weakness</label>
			<input type="text" class="input-md" name="attr_weakness" />
		</div>
		<div class="resource-description-panel">
			<textarea data-i18n-placeholder="resource-description-placeholder" name="attr_resource_description"></textarea>
		</div>
		<div class="resource-panel border-right">
			<h5 class="panel-title" data-i18n="resource"></h5>
			<div class="resource-input-group">
				<input type="number" name="attr_resource" />
			</div>
			<div class="resource-name-input-group">
				<input type="text" class="input-md" name="attr_resource_name" data-i18n-placeholder="resource-name-placeholder" />
			</div>
		</div>
		<div class="surges-panel">
			<h5 class="panel-title" data-i18n="surges"></h5>
			<div class="surges-input-group">
				<input type="number" name="attr_surges" />
			</div>
			<label class="sublabel">
				1 Surge = Damage <input type="number" class="input-sm" name="attr_surge_damage" />
			</label>
			<label class="sublabel">
				2 Surges = Potency + 1
			</label>
		</div>
		<div class="conditions-panel">
			<h5 class="panel-title" data-i18n="conditions"></h5>
			<fieldset class="repeating_conditions">
				<input type="text" name="attr_condition_name" data-i18n-placeholder="condition" />
				<div>
					<input type="radio" name="attr_end" value="eot" />
					<label data-i18n="eot"></label>
				</div>
				<div>
					<input type="radio" name="attr_end" value="save-ends" />
					<label data-i18n="save-ends"></label>
				</div>
			</fieldset>
		</div>
	</div>
	<div class="v-spacer"></div>
	<div class="biography-panel border minimizable">
		<div class="minimize-control">
			<input id="biography-minimize-checkbox" class="minimize" type="checkbox" checked />
			<label for="biography-minimize-checkbox" data-i18n="minimize-label"></label>
		</div>
		<div class="minimize-show">
			<h5 data-i18n="biography"></h5>
		</div>
		<div class="career-panel border">
			<h5 class="panel-title" data-i18n="career"></h5>
			<input type="text" name="attr_career" />
			<label class="sublabel" data-i18n="career-benefit"></label>
			<textarea name="attr_career_benefit"></textarea>
			<label class="sublabel" data-i18n="career-incident"></label>
			<textarea name="attr_career_incident"></textarea>
		</div>
		<div class="complication-panel border">
			<h5 class="panel-title" data-i18n="complication"></h5>
			<input type="text" name="attr_complication" />
			<label class="sublabel" data-i18n="complication-benefit"></label>
			<textarea name="attr_complication_benefit"></textarea>
			<label class="sublabel" data-i18n="complication-drawback"></label>
			<textarea name="attr_complication_drawback"></textarea>
		</div>
		<div class="culture-panel border">
			<h5 class="panel-title" data-i18n="culture"></h5>
			<label class="sublabel" data-i18n="culture-environment"></label>
			<label class="sublabel" data-i18n="culture-organization"></label>
			<label class="sublabel" data-i18n="culture-upbringing"></label>
			<input type="text" name="attr_culture_environment" />
			<input type="text" name="attr_culture_organization" />
			<input type="text" name="attr_culture_upbringing" />
			<textarea name="attr_culture_environment_description"></textarea>
			<textarea name="attr_culture_organization_description"></textarea>
			<textarea name="attr_culture_upbringing_description"></textarea>
		</div>
	</div>
	<div class="v-spacer"></div>
	<div class="skills-languages-panel border minimizable">
		<div class="minimize-control">
			<input id="skills-languages-minimize-checkbox" class="minimize" type="checkbox" checked />
			<label for="skills-languages-minimize-checkbox" data-i18n="minimize-label"></label>
		</div>
		<div class="minimize-show">
			<h5 data-i18n="skills-languages"></h5>
		</div>
		<div class="skills-panel">
			<h5 class="panel-title" data-i18n="skills"></h5>
			<label data-i18n="crafting"></label>
			<input type="text" name="attr_skills_crafting" />
			<label data-i18n="exploration"></label>
			<input type="text" name="attr_skills_exploration" />
			<label data-i18n="interpersonal"></label>
			<input type="text" name="attr_skills_interpersonal" />
			<label data-i18n="intrigue"></label>
			<input type="text" name="attr_skills_intrigue" />
			<label data-i18n="lore"></label>
			<input type="text" name="attr_skills_lore" />
		</div>
		<div class="languages-panel">
			<h5 class="panel-title" data-i18n="languages"></h5>
			<input type="text" data-i18n-placeholder="caelian" name="attr_languages" />
		</div>
	</div>
	<div class="v-spacer"></div>
	<div class="features-panel border minimizable">
		<div class="minimize-control">
			<input id="features-minimize-checkbox" class="minimize" type="checkbox" checked />
			<label for="features-minimize-checkbox" data-i18n="minimize-label"></label>
		</div>
		<div class="minimize-show">
			<h5 data-i18n="features"></h5>
		</div>
		<div class="class-panel border">
			<h5 class="panel-title" data-i18n="class-features"></h5>
			<textarea name="attr_class_features_1"></textarea>
			<textarea name="attr_class_features_2"></textarea>
		</div>
		<div class="ancestry-panel border">
			<h5 class="panel-title" data-i18n="ancestry-traits"></h5>
			<textarea name="attr_ancestry_traits"></textarea>
		</div>
		<div class="modifiers-panel border">
			<h5 class="panel-title" data-i18n="modifiers"></h5>
			<fieldset class="repeating_modifiers">
				<div class="modifier-card">
					<input type="text" class="modifier-all modifier-name" data-i18n-placeholder="modifier-name" name="attr_modifier_name" />
					<select class="modifier-all modifier-type" name="attr_modifier_type">
						<option value="basic" data-i18n="modifier-basic" selected></option>
						<option value="kit" data-i18n="kit"></option>
					</select>
					<div class="kit input-group kit-weapon-input-group">
						<input type="text" class="kit kit-weapon" name="attr_kit_weapon" />
						<label class="sublabel" data-i18n="weapon-implement"></label>
					</div>
					<div class="kit input-group">
						<input type="number" class="kit kit-speed" name="attr_kit_speed" />
						<label class="sublabel" data-i18n="speed"></label>
					</div>
					<div class="kit input-group">
						<input type="number" class="kit kit-melee-distance" name="attr_kit_melee_distance" />
						<label class="sublabel" data-i18n="melee"></label>
					</div>
					<div class="kit input-group">
						<input type="number" class="kit kit-ranged-distance" name="attr_kit_ranged_distance" />
						<label class="sublabel" data-i18n="ranged"></label>
					</div>
					<div class="kit input-group kit-armor-input-group">
						<input type="text" class="kit kit-armor" name="attr_kit_armor" />
						<label class="sublabel" data-i18n="armor"></label>
					</div>
					<div class="kit input-group">
						<input type="number" class="kit kit-disengage" name="attr_kit_disengage" />
						<label class="sublabel" data-i18n="disengage"></label>
					</div>
					<div class="kit input-group">
						<input type="number" class="kit kit-stability" name="attr_kit_stability" />
						<label class="sublabel" data-i18n="stability"></label>
					</div>
					<div class="kit input-group">
						<input type="number" class="kit kit-stamina" name="attr_kit_stamina" />
						<label class="sublabel" data-i18n="stamina"></label>
					</div>
					<label class="kit kit-damage-label sublabel" data-i18n="melee-weapon-damage"></label>
					<textarea class="modifier-all modifier-description" name="attr_modifier_description"></textarea>
					<div class="kit input-group kit-melee-damage-1-input-group">
						<input type="number" class="kit-melee-damage-1" name="attr_kit_melee_damage_1" />
						<label class="sublabel">≤11</label>
					</div>
					<div class="kit input-group kit-melee-damage-2-input-group">
						<input type="number" class="kit-melee-damage-2" name="attr_kit_melee_damage_2" />
						<label class="sublabel">12-16</label>
					</div>
					<div class="kit input-group kit-melee-damage-3-input-group">
						<input type="number" class="kit-melee-damage-3" name="attr_kit_melee_damage_3" />
						<label class="sublabel">17+</label>
					</div>
					<label class="kit kit-damage-label sublabel" data-i18n="ranged-weapon-damage"></label>
					<div class="kit input-group kit-ranged-damage-1-input-group">
						<input type="number" class="kit-ranged-damage-1" name="attr_kit_ranged_damage_1" />
						<label class="sublabel">≤11</label>
					</div>
					<div class="kit input-group kit-ranged-damage-2-input-group">
						<input type="number" class="kit-ranged-damage-2" name="attr_kit_ranged_damage_2" />
						<label class="sublabel">12-16</label>
					</div>
					<div class="kit input-group kit-ranged-damage-3-input-group">
						<input type="number" class="kit-ranged-damage-3" name="attr_kit_ranged_damage_3" />
						<label class="sublabel">17+</label>
					</div>
				</div>
			</fieldset>
		</div>
		<div class="perks-panel border">
			<h5 class="panel-title" data-i18n="perks"></h5>
			<fieldset class="repeating_perks">
				<div class="perk-card">
					<input type="text" name="attr_perk_name" />
					<textarea name="attr_perk_description"></textarea>
				</div>
			</fieldset>
		</div>
		<div class="titles-panel border">
			<h5 class="panel-title" data-i18n="titles"></h5>
			<fieldset class="repeating_titles">
				<div class="title-card">
					<input type="text" name="attr_title_name" />
					<textarea name="attr_title_description"></textarea>
				</div>
			</fieldset>
		</div>
	</div>
	<div class="v-spacer"></div>
	<div class="abilities-panel border minimizable">
		<div class="minimize-control">
			<input id="abilities-minimize-checkbox" class="minimize" type="checkbox" checked />
			<label for="abilities-minimize-checkbox" data-i18n="minimize-label"></label>
		</div>
		<div class="minimize-show">
			<h5 data-i18n="abilities"></h5>
		</div>
		<div class="free-strikes">
			<div class="ability-card">
				<input type="text" class="ability-name" data-i18n-placeholder="melee-free-strike" name="attr_melee_free_strike_name" />
				<input type="text" class="ability-keywords" data-i18n-placeholder="melee-free-strike-keywords" name="attr_melee_free_strike_keywords" />
				<select class="ability-type" disabled>
					<option value="mainAction" selected data-i18n="main-action"></option>
					<option value="maneuver" data-i18n="maneuver"></option>
					<option value="triggered-action" data-i18n="triggered-action"></option>
				</select>
				<input type="text" class="ability-distance" data-i18n-placeholder="distance" name="attr_melee_free_strike_distance" />
				<input type="text" class="ability-target" data-i18n-placeholder="one-creature-object" name="attr_melee_free_strike_target" />
				<div class="power-roll">
					<div class="power-roll-mods">
						<label data-i18n="power-roll"></label>
						<span>+</span>
						<input type="text" class="power-roll-characteristic" data-i18n-placeholder="might-or-agility" name="attr_melee_free_strike_characteristic" />
					</div>
					<label class="sublabel">≤11</label>
					<input type="text" class="power-roll-tier-effect" name="attr_melee_free_strike_tier_1" />
					<label class="sublabel">12-16</label>
					<input type="text" class="power-roll-tier-effect" name="attr_melee_free_strike_tier_2" />
					<label class="sublabel">17+</label>
					<input type="text" class="power-roll-tier-effect" name="attr_melee_free_strike_tier_3" />
				</div>
			</div>
			<div class="ability-card">
				<input type="text" class="ability-name" data-i18n-placeholder="ranged-free-strike" name="attr_ranged_free_strike_name" />
				<input type="text" class="ability-keywords" data-i18n-placeholder="ranged-free-strike-keywords" />
				<select class="ability-type" disabled>
					<option value="mainAction" selected data-i18n="main-action"></option>
					<option value="maneuver" data-i18n="maneuver"></option>
					<option value="triggered-action" data-i18n="triggered-action"></option>
				</select>
				<input type="text" class="ability-distance" data-i18n-placeholder="distance" name="attr_ranged_free_strike_distance" />
				<input type="text" class="ability-target" data-i18n-placeholder="one-creature-object" name="attr_ranged_free_strike_target" />
				<div class="power-roll">
					<div class="power-roll-mods">
						<label data-i18n="power-roll"></label>
						<span>+</span>
						<input type="text" class="power-roll-characteristic" data-i18n-placeholder="might-or-agility" name="attr_ranged_free_strike_characteristic" />
					</div>
					<label class="sublabel">≤11</label>
					<input type="text" class="power-roll-tier-effect" name="attr_ranged_free_strike_tier_1" />
					<label class="sublabel">12-16</label>
					<input type="text" class="power-roll-tier-effect" name="attr_ranged_free_strike_tier_2" />
					<label class="sublabel">17+</label>
					<input type="text" class="power-roll-tier-effect" name="attr_ranged_free_strike_tier_3" />
				</div>
			</div>
		</div>
		<fieldset class="repeating_abilities">
			<div class="ability-card">
				<input type="text" class="ability-name" data-i18n-placeholder="ability-name" name="attr_ability_name" />
				<div class="ability-cost-input-group">
					<label data-i18n="ability-cost"></label>
					<input type="number" name="attr_ability_cost" />
				</div>
				<input type="text" class="ability-description" data-i18n-placeholder="ability-description" name="attr_ability_description" />
				<input type="text" class="ability-keywords" data-i18n-placeholder="keywords" name="attr_ability_keywords" />
				<select class="ability-type" name="attr_ability_type">
					<option value="" selected data-i18n="no-action"></option>
					<option value="main-action" data-i18n="main-action"></option>
					<option value="maneuver" data-i18n="maneuver"></option>
					<option value="free-maneuver" data-i18n="free-maneuver"></option>
					<option value="move" data-i18n="move-action"></option>
					<option value="triggered-action" data-i18n="triggered-action"></option>
					<option value="free-triggered-action" data-i18n="free-triggered-action"></option>
				</select>
				<input type="text" class="ability-distance" data-i18n-placeholder="distance" name="attr_ability_distance" />
				<input type="text" class="ability-target" data-i18n-placeholder="target" name="attr_ability_target" />
				<textarea class="ability-trigger triggered-show" data-i18n-placeholder="trigger" name="attr_ability_trigger"></textarea>
				<div class="power-roll">
					<div class="power-roll-mods">
						<input type="checkbox" name="attr_has_power_roll" />
						<label data-i18n="power-roll"></label>
						<span>+</span>
						<input type="text" class="power-roll-characteristic" name="attr_ability_characteristic" />
					</div>
					<label class="sublabel">≤11</label>
					<input type="text" class="power-roll-tier-effect" name="attr_ability_tier_1" />
					<label class="sublabel">12-16</label>
					<input type="text" class="power-roll-tier-effect" name="attr_ability_tier_2" />
					<label class="sublabel">17+</label>
					<input type="text" class="power-roll-tier-effect" name="attr_ability_tier_3" />
				</div>
				<textarea class="ability-effect" data-i18n-placeholder="effect" name="attr_ability_effect"></textarea>
			</div>
		</fieldset>
	</div>
	<div class="v-spacer"></div>
	<div class="projects-panel border minimizable">
		<div class="minimize-control">
			<input id="projects-minimize-checkbox" class="minimize" type="checkbox" checked />
			<label for="projects-minimize-checkbox" data-i18n="minimize-label"></label>
		</div>
		<div class="minimize-show">
			<h5 data-i18n="projects"></h5>
		</div>
		<fieldset class="repeating_projects">
			<input type="text" data-i18n-placeholder="project-name" name="attr_project_name" />
			<input type="text" data-i18n-placeholder="assigned-hero-follower" name="attr_project_assigned" />
			<input type="text" data-i18n-placeholder="characteristic" name="attr_project_characteristic" />
			<div class="project-goal-input-group">
				<input type="number" name="attr_project_goal" />
				/
				<input type="number" name="attr_project_goal_max" />
			</div>
		</fieldset>
	</div>
	<div class="v-spacer"></div>
	<div class="import-panel border minimizable">
		<div class="minimize-control">
			<input id="import-minimize-checkbox" class="minimize" type="checkbox" checked />
			<label for="import-minimize-checkbox" data-i18n="minimize-label"></label>
		</div>
		<div class="minimize-show">
			<h5>Import</h5>
		</div>
		<p>Paste the contents of the Forge Steel data export (*.ds-hero file) into the text box below, then click "Import".</p>
		<p class="text-warning">This will overwrite attributes on this sheet. This cannot be undone.</p>
		<textarea name="attr_forgesteel_json"></textarea>
		<button type="action" name="act_import">Import</button>
	</div>
	<div style="font-family: Menlo, Monaco, Consolas">This Draw Steel character sheet for Roll20 is an independent product published under the DRAW STEEL Creator License and is not affiliated with MCDM Productions, LLC. DRAW STEEL © 2024 MCDM Productions, LLC.</div>
</div>
<rolltemplate class="sheet-rolltemplate-powerroll">
	<div class="powerroll-content">
		<h1>{{name}}</h1>
		{{#allprops() edgeBane tier}}
		<div>{{key}}: {{value}}</div>
		{{/allprops() edgeBane tier}}
		{{#rollGreater() edgeBane 0}}
		<div>Edge: {{edgeBane}}</div>
		{{/rollGreater() edgeBane 0}}
		{{#rollLess() edgeBane 0}}
		<div>Bane: {{edgeBane}}</div>
		{{/rollLess() edgeBane 0}}
		{{#rollGreater() 2d10 18}}
			<div class="powerroll-crit">Critical</div>
		{{/rollGreater() 2d10 18}}
		<div class="powerroll-tier">
			Result: Tier {{computed::tier}}
		</div>
	</div>
</rolltemplate>
<script type="text/worker">
	function setActiveCharacterId(id) {
		const ocid = getActiveCharacterId();
		const data = {
			id: '0',
			type: 'setActiveCharacter',
			data: id,
		};
		if (self.dispatchEvent) {
			const event = new CustomEvent('message');
			event.data = data;
			self.dispatchEvent(event);
		}
		else {
			self.onmessage({ data });
		}
		return ocid;
	}
	function getAttrsAsync(props) {
		const acid = getActiveCharacterId();
		let ocid = null;
		return new Promise((resolve, reject) => {
			ocid = setActiveCharacterId(acid);
			try {
				getAttrs(props, (values) => resolve(values));
			}
			catch {
				reject();
			}
		}).finally(() => {
			setActiveCharacterId(ocid);
		});
	}
	function setAttrsAsync(props) {
		const acid = getActiveCharacterId();
		let ocid = null;
		return new Promise((resolve, reject) => {
			ocid = setActiveCharacterId(acid);
			try {
				setAttrs(props, undefined, (values) => resolve(values));
			}
			catch {
				reject();
			}
		}).finally(() => {
			setActiveCharacterId(ocid);
		});
	}
	function getSectionIDsAsync(sectionName) {
		const acid = getActiveCharacterId();
		let ocid = null;
		return new Promise((resolve, reject) => {
			ocid = setActiveCharacterId(acid);
			try {
				getSectionIDs(sectionName, (values) => resolve(values));
			}
			catch {
				reject();
			}
		}).finally(() => {
			setActiveCharacterId(ocid);
		});
	}

	$20('.characteristic-input-group > label').on('click', async (e) => {
		const characteristic = e.htmlAttributes['data-characteristic'];
		const characteristicTranslation = getTranslationByKey(characteristic);
		const attrs = await getAttrsAsync([characteristic]);
		const characteristicValue = attrs[characteristic];
		const roll = '&{template:powerroll} ' +
			'[[ [[2d10cs>11cf<0]][2d10] ' +
			` + [[${characteristicValue}[${characteristicTranslation}]]][${characteristicTranslation}] `+
			' + [[?{Edge or Bane|None,0|Double Edge,0[Double Edge]|Edge,2[Edge]|Bane,-2[Bane]|Double Bane,0[Double Bane]}]][Edge or Bane] ' +
			' + [[?{Bonus or Penalty|0}]][Bonus or Penalty] ' +
			']] ' +
			`{{name=${characteristicTranslation} Power Roll}} ` +
			'{{2d10=$[[0]]}} ' +
			'{{characteristic=$[[1]]}} ' +
			'{{edgeBane=$[[2]]}} ' +
			'{{bonus=$[[3]]}} ' +
			'{{total=$[[4]]}} ' +
			'{{tier=[[0]]}}'; // placeholder for computed value
		console.log('roll', roll);
		startRoll(roll, ({ rollId, results }) => {
			console.log('roll results', results);
			const tierBase = (() => {
				if (results.total.result >= 17) {
					return 3;
				}
				return results.total.result >= 12
					? 2
					: 1;
			})();
			const tierMod = (() => {
				switch (results.edgeBane.expression) {
					case '0[Double Edge]':
						return 1;
					case '0[Double Bane]':
						return -1;
					default:
						return 0;
				}
			})();
			const tier = Math.max(1, Math.min(3, tierBase + tierMod));
			finishRoll(rollId, { tier });
		});
	});

	/**
	** import start
	**/
	function flattenFeatures(features, level) {
		const deepFeatureTypes = [
			'Choice',
			'Domain',
			'Kit',
			'Multiple Features',
		];
		if (!features.some(x => deepFeatureTypes.includes(x.type))) {
			return features;
		}
		const flatFeatures = features
			.flatMap(x => {
				switch (x.type) {
					case 'Choice':
						return x.data.selected;
					case 'Domain':
						return [
							...x.data.selected
								.map(y => ({ ...y, type: 'DomainChoice' })),
							...x.data.selected
								.flatMap(y => y.featuresByLevel)
								.filter(y => y.level <= level)
								.flatMap(y => y.features),
						];
					case 'Kit':
						return x.data.selected
							.flatMap(y => [
								{ ...y, type: 'KitStats', features: undefined },
								...y.features,
							]);
					case 'Multiple Features':
						return x.data.features;
					default:
						return x;
				}
			});
		return flattenFeatures(flatFeatures, level);
	}
	function getFeatures(forgesteelData) {
		const level = forgesteelData.class.level;
		const baseFeatures = [
			...forgesteelData.features,
			...forgesteelData.ancestry.features,
			...forgesteelData.career.features,
			...forgesteelData.class
				.featuresByLevel.filter(x => x.level <= level)
				.flatMap(x => x.features),
			...forgesteelData.class
				.subclasses.filter(x => x.selected)
				.flatMap(x => x.featuresByLevel)
				.filter(x => x.level <= level)
				.flatMap(x => x.features),
			forgesteelData.culture.environment,
			forgesteelData.culture.organization,
			forgesteelData.culture.upbringing,
		];
		return flattenFeatures(baseFeatures, level);
	}
	async function clearRepeatingSection(sectionName) {
		const sectionIDs = await getSectionIDsAsync(sectionName);
		for (const sectionID of sectionIDs) {
			removeRepeatingRow(`repeating_${sectionName}_${sectionID}`);
		}
	}

	on('clicked:import', async () => {
		const { forgesteel_json } = await getAttrsAsync(['forgesteel_json']);
		try {
			const forgesteelData = JSON.parse(forgesteel_json);

			const features = getFeatures(forgesteelData);

			const character_name = forgesteelData.name;
			const ancestry = forgesteelData.ancestry.name;
			const classs = forgesteelData.class.name;
			const career = forgesteelData.career.name;
			const subclass = [
				...forgesteelData.class.subclasses
					.filter(x => x.selected)
					.map(x => x.name),
				...features
					.filter(x => x.type === 'DomainChoice')
					.map(x => x.name),
			].join(', ');
			const victories = forgesteelData.state.victories;
			const level = forgesteelData.class.level;
			const wealth = forgesteelData.state.wealth;
			const renown = forgesteelData.state.renown;
			const experience = forgesteelData.state.xp;
			const might = forgesteelData.class.characteristics
				.find(x => x.characteristic === 'Might').value;
			const agility = forgesteelData.class.characteristics
				.find(x => x.characteristic === 'Agility').value;
			const reason = forgesteelData.class.characteristics
				.find(x => x.characteristic === 'Reason').value;
			const intuition = forgesteelData.class.characteristics
				.find(x => x.characteristic === 'Intuition').value;
			const presence = forgesteelData.class.characteristics
				.find(x => x.characteristic === 'Presence').value;
			const potency_strong = Math.max(might, agility, reason, intuition, presence);
			const sizeObject = features.filter(x => x.type === 'Size')
				.map(x => x.data.size)
				[0]
				?? { value: 1, mod: 'M' };
			const size = `${sizeObject.value}${sizeObject.mod ?? ''}`;
			const speed = [
				features
					.filter(x => x.type === 'Speed')
					.map(x => x.data.speed)
					[0]
					?? 5,
				...features
					.filter(x => x.type === 'Bonus' && x.data.field === 'Speed')
					.map(x => x.data.field.value),
				Math.max(
					...features
						.filter(x => x.type === 'KitStats')
						.map(x => x.speed),
					0
				),
			].reduce((sum, speed) => sum + speed, 0);
			const disengage = [
				1,
				...features
					.filter(x => x.type === 'Bonus' && x.data.field === 'Disengage')
					.map(x => x.data.field.value),
				Math.max(
					...features
						.filter(x => x.type === 'KitStats')
						.map(x => x.disengage),
					0
				),
			].reduce((sum, speed) => sum + speed, 0);
			const stability = [
				...features
					.filter(x => x.type === 'Bonus' && x.data.field === 'Stability')
					.map(x => x.data.field.value),
				Math.max(
					...features
						.filter(x => x.type === 'KitStats')
						.map(x => x.stability),
					0
				),
			].reduce((sum, speed) => sum + speed, 0);
			const stamina_max = [
				...features
					.filter(x => x.type === 'Bonus' && x.data.field === 'Stamina')
					.map(x => x.data.value + ((level - 1) * x.data.valuePerLevel)),
				Math.max(
					...features
						.filter(x => x.type === 'KitStats')
						.map(x => Math.floor((level + 2) / 3) * x.stamina),
					0
				),
			].reduce((sum, stamina) => sum + stamina, 0);
			const recoveries_max = [
				...features
					.filter(x => x.type === 'Bonus' && x.data.field === 'Recoveries')
					.map(x => x.data.value),
			].reduce((sum, recoveries) => sum + recoveries, 0);
			const damageTypes = [
				'Acid',
				'Cold',
				'Corruption',
				'Fire',
				'Holy',
				'Lightning',
				'Poison',
				'Psychic',
				'Sonic',
			];
			const immunity = damageTypes
				.map(damageType => {
					const amount = features
						.filter(x => x.type === 'Damage Modifier')
						.flatMap(x => x.data.modifiers)
						.filter(x => x.damageType === damageType && x.type === 'Immunity')
						.map(x => x.value + ((level - 1) * x.valuePerLevel))
						.reduce((sum, value) => sum + value, 0)
					return { damageType, amount };
				})
				.filter(({ amount }) => amount)
				.map(({ damageType, amount }) => `${damageType} ${amount}`)
				.join(', ');
			const weakness = damageTypes
				.map(damageType => {
					const amount = features
						.filter(x => x.type === 'Damage Modifier')
						.flatMap(x => x.data.modifiers)
						.filter(x => x.damageType === damageType && x.type === 'Weakness')
						.map(x => x.value + ((level - 1) * x.valuePerLevel))
						.reduce((sum, value) => sum + value, 0)
					return { damageType, amount };
				})
				.filter(({ amount }) => amount)
				.map(({ damageType, amount }) => `${damageType} ${amount}`)
				.join(', ');
			const resource_name = features.find(x => x.type === 'Heroic Resource').name;
			// biography
			const career_incident = (() => {
				const incidentOption = forgesteelData.career.incitingIncidents.options
					.find(x => x.id === forgesteelData.career.incitingIncidents.selectedID);
				return incidentOption
					? `${incidentOption.name}\n${incidentOption.description}`
					: '';
			})();
			const complication = forgesteelData.complication?.name ?? '';
			const complication_benefit = forgesteelData.complication
				?.features[0]?.description
				?? '';
			const complication_drawback = forgesteelData.complication
				?.features[1]?.description
				?? '';
			const	culture_environment = forgesteelData.culture.environment.name;
			const culture_environment_description = forgesteelData.culture.environment.description;
			const culture_organization = forgesteelData.culture.organization.name;
			const culture_organization_description = forgesteelData.culture.organization.description;
			const culture_upbringing = forgesteelData.culture.upbringing.name;
			const culture_upbringing_description = forgesteelData.culture.upbringing.description;
			// skills and languages
			const skills_crafting = features
				.filter(x => x.type === 'Skill Choice')
				.flatMap(x => x.data.selected)
				.filter(x => [
					'Alchemy', 'Architecture', 'Blacksmithing', 'Carpentry', 'Cooking',
					'Fletching', 'Forgery', 'Jewelry', 'Mechanics', 'Tailoring',
				].includes(x))
				.join(', ');
			const skills_exploration = features
				.filter(x => x.type === 'Skill Choice')
				.flatMap(x => x.data.selected)
				.filter(x => [
					'Climb', 'Drive', 'Endurance', 'Gymnastics', 'Heal',
					'Jump', 'Lift', 'Navigate', 'Ride', 'Swim',
				].includes(x))
				.join(', ');
			const skills_interpersonal = features
				.filter(x => x.type === 'Skill Choice')
				.flatMap(x => x.data.selected)
				.filter(x => [
					'Brag', 'Emphathize', 'Flirt', 'Gamble', 'Handle Animals',
					'Interrogate', 'Intimidate', 'Lead', 'Lie', 'Music',
					'Perform', 'Persuade', 'Read Person',
				].includes(x))
				.join(', ');
			const skills_intrigue = features
				.filter(x => x.type === 'Skill Choice')
				.flatMap(x => x.data.selected)
				.filter(x => [
					'Alertness', 'Conceal Object', 'Disguise', 'Eavesdrop',
					'Escape Artist', 'Hide', 'Pick Lock', 'Pick Pocket', 'Sabotage',
					'Search', 'Sneak', 'Track',
				].includes(x))
				.join(', ');
			const skills_lore = features
				.filter(x => x.type === 'Skill Choice')
				.flatMap(x => x.data.selected)
				.filter(x => [
					'Criminal Underworld', 'Culture', 'History', 'Magic', 'Monsters',
					'Nature', 'Psionics', 'Religion', 'Rumors', 'Society',
					'Strategy', 'Timescape',
				].includes(x))
				.join(', ');
			const languages = [
				...forgesteelData.culture.languages,
				...features
					.filter(x => x.type === 'Language Choice')
					.flatMap(x => x.data.selected),
			].join(', ');

			const kits = features
				.filter(x => x.type === 'KitStats')
				.reduce(
					(acc, x) => {
						const id = generateRowID();
						return {
							...acc,
							[`repeating_modifiers_${id}_modifier_name`]: x.name, 
							[`repeating_modifiers_${id}_modifier_type`]: 'kit',
							[`repeating_modifiers_${id}_kit_weapon`]: x.weapon.join(', '),
							[`repeating_modifiers_${id}_kit_armor`]: x.armor.join(', '),
							[`repeating_modifiers_${id}_kit_speed`]: x.speed,
							[`repeating_modifiers_${id}_kit_melee_distance`]: x.meleeDistance,
							[`repeating_modifiers_${id}_kit_ranged_distance`]: x.rangedDistance,
							[`repeating_modifiers_${id}_kit_disengage`]: x.disengage,
							[`repeating_modifiers_${id}_kit_stability`]: x.stability,
							[`repeating_modifiers_${id}_kit_stamina`]: x.stamina,
							[`repeating_modifiers_${id}_kit_melee_damage_1`]: x.meleeDamage?.tier1 ?? '',
							[`repeating_modifiers_${id}_kit_melee_damage_2`]: x.meleeDamage?.tier2 ?? '',
							[`repeating_modifiers_${id}_kit_melee_damage_3`]: x.meleeDamage?.tier3 ?? '',
							[`repeating_modifiers_${id}_kit_ranged_damage_1`]: x.rangedDamage?.tier1 ?? '',
							[`repeating_modifiers_${id}_kit_ranged_damage_2`]: x.rangedDamage?.tier2 ?? '',
							[`repeating_modifiers_${id}_kit_ranged_damage_3`]: x.rangedDamage?.tier3 ?? '',
							[`repeating_modifiers_${id}_modifier_description`]: x.description,
						}
					},
					{}
				);

			const newAttrs = {
				forgesteel_json: '',
				// core
				character_name,
				ancestry,
				class: classs,
				career,
				subclass,
				victories,
				level,
				wealth,
				renown,
				experience,
				// stats
				might,
				agility,
				reason,
				intuition,
				presence,
				potency_strong,
				potency_average: potency_strong - 1,
				potency_weak: potency_strong - 2,
				size,
				speed,
				disengage,
				stability,
				stamina_max,
				stamina_winded: Math.floor(stamina_max / 2),
				stamina_dead: 0 - Math.floor(stamina_max / 2),
				recoveries_max,
				recovery_amount: Math.floor(stamina_max / 3),
				immunity,
				weakness,
				resource_name,
				surge_damage: potency_strong,
				// biography
				career_incident,
				complication,
				complication_benefit,
				complication_drawback,
				culture_environment,
				culture_environment_description,
				culture_organization,
				culture_organization_description,
				culture_upbringing,
				culture_upbringing_description,
				// skills and languages
				skills_crafting,
				skills_exploration,
				skills_interpersonal,
				skills_intrigue,
				skills_lore,
				languages,
				...kits,
			};
			console.log('import attributes', newAttrs);

			await clearRepeatingSection('modifiers');
			await setAttrsAsync(newAttrs);
		}
		catch (e) {
			console.error(e);
		}
	});
	/**
	** import end
	**/
</script>
